# 文件上传系统

## 1. 服务端后端框架搭建集成

| 组件 | 技术选型 |
|------|----------|
| DI | AutoFac |
| ORM | SqlSugar |
| Cache | Redis |
| Log | Nlog |
| 其他 | 程序中服务类重新封装，通用组件调整 |

## 2. 账号管理

| 管理模块 | 说明 |
|----------|------|
| 机构管理 | 机构信息管理 |
| 部门管理 | 部门信息管理 |
| 平台管理 | 平台信息管理 |
| 账号管理 | 用户账号管理 |

## 3. 权限管理

| 功能 | 实现方式 |
|------|----------|
| 登录端管理 | 区分客户端、服务端 |
| 角色权限展示 | 通过拦截器、AuthorizationHandler、ApiAuthorizeFilter来判断角色权限，展示不同页面 |

## 4. 基础数据同步

| 同步内容 | 说明 |
|----------|------|
| 机构同步 | 机构信息同步 |
| 科室信息同步 | 科室信息同步 |
| 账号同步 | 账号信息同步 |

## 5. 客户端相关接口

| 接口类型 | 功能 |
|----------|------|
| 登录接口 | 客户端登录认证 |
| 文件上传信息接口 | 文件上传信息处理 |
| 客户端健康检查接口 | 客户端状态监控 |
| 客户端异常信息接口 | 异常信息收集 |

## 6. AI中台对接

| 功能 | 说明 |
|------|------|
| 上传信息同步 | 包含无关联关系（根据条码号和样本号） |
| 手动绑定关联关系 | AI中台手动绑定关联关系信息反同 |

## 7. 客户端功能

### 7.1 文件监控

| 监控方式 | 说明 |
|----------|------|
| 实时监控 | 利用文件系统事件（如inotify/FileSystemWatcher）实现实时监控 |
| 定时扫描 | 配合定时扫描确保遗漏文件捕捉 |
| 事件记录 | 记录下事件详细信息，在配置的执行时间段异步处理 |

### 7.2 流程逻辑

#### 客户端流程
1. 客户端使用Winform + AntdUI，客户端登录
![客户端登录](https://github.com/user-attachments/assets/0a513214-1734-4736-9ab3-af1edb8a5773)

**目的**：为了解决不同平台下，不同大小组，分别上次文件绑定到不同oss地址（机构下有平台，平台绑定大小组和对应桶）
**配置方式**：客户端在上传配置的时候进行配置，例如（勾选大小组后配置大小组下对应的桶信息）

#### 服务端流程
> 通过定时任务发送http接口到iris接口，完成流程（同时根据接收编号，来判断质控标识，如果真则调用接口使用质控模板发送http请求）

## 8. 仪器接口

### 8.1 携光网口通讯

| 通讯方式 | 说明 |
|----------|------|
| TCP网口通讯 | 获取设备发过来的条码号或接收编号，通过http接口发送给iris系统（通过base64编码） |

### 8.2 串口双向通讯（优利特 US1680）

| 步骤 | 功能 |
|------|------|
| 1. 截取标识位 | 解析出当前仪器发送的为请求检测信息标识，根据仪器发送过来的信息解析出条码号 |
| 2. 解析仪器数据包 | 获取对应的检测项目（可能存在多个检测项目），组装成仪器所需要的数据，发送给仪器，仪器会根据检测项目去执行对应检测项目逻辑，后仪器发送数据包过来，通过标识位解析出当前项目的结果值，生成报文写入到指定txt文件下 |
| 3. Http上传数据 | 通过定时任务发送http接口到iris接口，完成流程（同时根据接收编号，来判断质控标识，如果真则调用接口使用质控模板发送http请求） |

**交互方式**：网口交互、串口交互、共享文件交互、数据库交互

## 9. 工作内容总结

### 9.1 系统功能

| 功能 | 说明 |
|------|------|
| 文件上传流程 | 简化并自动化医检大数据平台的样本文件上传流程。通过对指定文件夹的实时监控，系统可自动识别并上传新增文件，并将上传后的文件路径与IRIS系统中对应的样本信息建立绑定关系，最终同步至医检大数据平台，实现文件数据的高效归集与统一管理 |

### 9.2 用户角色

| 角色 | 职责 |
|------|------|
| 上传人员 | 负责日常文件的上传与任务管理 |
| 系统管理员 | 负责权限配置、系统维护与异常监控等后台管理工作 |

### 9.3 技术实现

| 工作内容 | 详细说明 |
|----------|----------|
| 后端框架搭建 | 封装数据访问层、帮助类、中间件（使用中间件，对返回的数据加密等，错误日志）、角色等登录功能（使用Filter拦截方法）、异常日志功能、AOP中间件（抽离重复字段查询） |
| 基础数据接口 | 预警管理通过页面配置时间窗口，转成cron表达式通过定时任务，来统计obs上传失败率和iris关联失败率 |
| 产品协调 | 协调产品沟通、技术、原型梳理评审，验证可行性确保原型设计在技术层面可实现，分析技术难点与潜在风险，明确需求边界，避免原型设计超出实际业务需求，确保原型与产品需求文档一致 |
| 客户端监控 | 监控文件状态变化修改（FileSystemWatcher），根据用户配置、文件夹路径和正则表达式，解析符合文件要求的列表，添加到任务队列中，通过读取文件队列，上传到华为obs中，上传完成后发送请求给服务端，服务端接收数据写入数据表（上传完成到数据表中有数据后，使用定时任务，轮询调用http请求接口，通过条码号、大小组、检测编号等字段数据发送请求，同时使用redis缓存缓存相同postdata数据，文件可能会存在重复）关联iris文件状态 | 